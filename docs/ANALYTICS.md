# 埋点追踪系统文档（轻量优化版）

## 概述

本项目已集成的埋点追踪系统经过优化，在保证核心数据收集的前提下，**大幅减少数据量并降低提交频率**。

## 核心优化

### 数据量优化
- ✅ **简化数据结构**：字段名缩写，减少70%数据量
- ✅ **移除冗余信息**：去掉重复字段和不必要的元数据
- ✅ **智能节流**：频繁操作（搜索、分类切换）只统计不立即记录
- ✅ **批量合并**：统计相同类型事件的次数，一次性提交

### 频率优化
- ✅ **同步间隔**：从30秒改为**5分钟**（300秒）
- ✅ **节流控制**：
  - 搜索操作：3秒内只记录1次
  - 分类切换：2秒内只记录1次
  - 页面访问：5秒内只记录1次
- ✅ **按需同步**：只在关键时机触发同步

## 数据存储

- **API**: Pantry Cloud (https://getpantry.cloud)
- **Pantry ID**: 9eafe9e6-8ff7-41ab-b111-ecabbc1685a7
- **Basket**: GAME

## 追踪的核心数据

### 1. 游戏时长统计 ✓（最重要）
- 游戏ID和名称
- 开始时间戳
- 结束时间戳
- 游戏时长（毫秒）
- 是否有存档
- 存档操作次数

### 2. 用户行为统计（精简）
- 游戏点击次数（批量统计）
- 分类浏览次数（批量统计）
- 搜索次数（批量统计）
- 存档操作类型（关键操作）

### 3. 页面访问（节流）
- 应用启动
- 游戏列表页
- 游戏页面
- 游戏退出

## 优化后的数据结构

```json
{
  "v": "2.0",
  "u": "lx3k2j1m",
  "c": 1736942400000,
  "ls": 1736946000000,
  "te": 25,
  "events": [
    {
      "t": "gs",
      "ts": 1736942400000,
      "d": {
        "g": "tetris",
        "n": "俄罗斯方块"
      }
    },
    {
      "t": "ge",
      "ts": 1736942700000,
      "d": {
        "g": "tetris",
        "d": 300000,
        "sv": true,
        "so": 2
      }
    },
    {
      "t": "stats",
      "ts": 1736943000000,
      "d": {
        "gc": {
          "tetris": 5,
          "adarkroom": 3
        },
        "cc": {
          "rpg": 3,
          "puzzle": 5
        },
        "sc": 8
      }
    }
  ]
}
```

**字段说明**：
- `v`: 版本号
- `u`: 用户ID（匿名）
- `c`: 创建时间戳
- `ls`: 最后同步时间戳
- `te`: 总事件数
- `events`: 事件数组

**事件类型缩写**：
- `gs`: game_start（游戏开始）
- `ge`: game_end（游戏结束）
- `so`: save_operation（存档操作）
- `pv`: page_view（页面访问）
- `ua`: user_action（用户行为）
- `stats`: 统计汇总（批量数据）

## 数据同步策略

### 防止数据膨胀机制 ✅ NEW
- ✅ **立即清空本地队列**：拉取服务器数据后立即清空，避免重复提交
- ✅ **限制事件总数**：服务器最多保留1000个事件，超出自动裁剪旧事件
- ✅ **防止重复**：以服务器数据为准，本地不积累历史数据

### 同步流程优化

**优化前的问题**：
```
1. 拉取服务器数据（1000个事件）
2. 追加本地新事件（10个）
3. 上传1010个事件
4. 清空本地队列
5. 下次又变成1020个... ❌ 无限增长
```

**优化后的方案**：
```
1. 拉取服务器数据（1000个事件）
2. 立即清空本地队列 ✅
3. 追加本地新事件（10个）
4. 裁剪到1000个，上传
5. 永远保持1000个上限 ✅
```

### 同步频率对比

| 场景 | 优化前 | 优化后 |
|-----|-------|-------|
| 定时同步 | 30秒 | **5分钟** |
| 搜索操作 | 每次 | **3秒节流** |
| 分类切换 | 每次 | **2秒节流** |
| 页面访问 | 每次 | **5秒节流** |

### 同步触发条件
- ✅ 定时器（每5分钟）
- ✅ 页面重新可见（延迟5秒后）
- ✅ 网络恢复连接（延迟3秒后）
- ✅ 页面卸载前（使用 sendBeacon）

### 数据量对比

**优化前单个事件**：约500 bytes
```json
{
  "id": "event_1736942400000_abc123",
  "type": "game_start",
  "userId": "user_1736940000000_xyz789",
  "sessionId": "session_1736942400000_def456",
  "timestamp": "2025-01-15T10:30:00.000Z",
  "data": {
    "game": {
      "id": "tetris",
      "name": "俄罗斯方块",
      "category": "puzzle",
      "tags": ["益智", "消除", "经典"]
    }
  },
  "system": {
    "userAgent": "Mozilla/5.0...",
    "platform": "Win32",
    "language": "zh-CN",
    "isUTools": true
  }
}
```

**优化后单个事件**：约150 bytes（减少70%）
```json
{
  "t": "gs",
  "ts": 1736942400000,
  "d": {
    "g": "tetris",
    "n": "糖果盒子2"
  }
}
```

### 队列限制
- 优化前：最多保留100个未同步事件
- **优化后：最多保留50个未同步事件**

## 使用方法（不变）

系统已自动集成，无需额外配置：
- `src/views/GameView.vue`: 游戏页面追踪
- `src/GameList/index.vue`: 游戏列表页追踪

## 性能对比

### 5分钟使用场景数据量估算

| 场景 | 优化前 | 优化后 | 减少 |
|-----|-------|-------|------|
| 正常浏览 | ~50个事件 | ~10个事件 | **80%** |
| 频繁搜索 | ~100个事件 | ~15个事件 | **85%** |
| 游戏游玩 | ~20个事件 | ~5个事件 | **75%** |

### API调用频率

| 时间段 | 优化前 | 优化后 |
|-------|-------|-------|
| 1小时 | 120次 | **12次** |
| 1天（8小时使用） | 960次 | **96次** |

## 数据分析示例

### 游戏时长
```javascript
// 从 events 中筛选 game_end 事件
const gameSessions = events
  .filter(e => e.t === 'ge')
  .map(e => ({
    game: e.d.g,
    duration: e.d.d, // 毫秒
    hasSave: e.d.sv,
    saveOps: e.d.so
  }))

// 计算平均时长
const avgDuration = gameSessions.reduce((sum, s) => sum + s.duration, 0) / gameSessions.length
```

### 游戏偏好
```javascript
// 从 stats 事件中获取点击统计
const stats = events.filter(e => e.t === 'stats')
const gameClicks = {}
stats.forEach(s => {
  Object.assign(gameClicks, s.d.gc)
})

// 排序找出最受欢迎的游戏
const popularGames = Object.entries(gameClicks)
  .sort((a, b) => b[1] - a[1])
```

## 调试

查看当前状态（精简版）：
```javascript
analyticsTracker.getStats()
// 返回：
// {
//   pendingEvents: 8,
//   eventStats: {
//     gameClicks: { candybox2: 3, tetris: 2 },
//     categoryViews: { rpg: 5, puzzle: 3 },
//     searchCount: 7
//   },
//   currentSession: { gameId: 'candybox2', duration: 120000 }
// }
```

## 隐私说明

- 所有数据均为匿名收集
- 用户ID为随机短字符串
- 不收集设备指纹、User Agent等敏感信息
- 符合最小化数据收集原则

## 技术实现

- **文件**: `src/utils/analyticsTracker.js`
- **版本**: v2.0（轻量优化版）
- **依赖**: 无外部依赖
- **兼容性**: 支持所有现代浏览器和 uTools 环境

## 优化效果总结

✅ **数据量减少 70%** - 通过字段缩写和结构简化
✅ **提交频率降低 90%** - 从30秒改为5分钟
✅ **API调用减少 90%** - 从960次/天降至96次/天
✅ **存储空间节省 75%** - 批量合并频繁事件
✅ **性能影响最小** - 节流控制不影响用户体验

