# Candy Box 2 存档持久化解决方案

## 📋 问题说明

**原问题**：Candy Box 2 游戏使用浏览器的 `localStorage` 保存存档，但在 uTools 环境中：
- uTools 使用 `ubrowser` 打开游戏窗口
- `ubrowser` 创建的是临时浏览器上下文
- 每次关闭窗口后，`localStorage` 数据会被清除
- 导致游戏进度无法保存

## ✅ 已实施的解决方案

### 方案一：uTools 数据库桥接器（已实现）

**实现方式**：
创建了一个 `utools-storage-bridge.js` 桥接器，将游戏的 `localStorage` 操作自动同步到 uTools 数据库。

**工作原理**：
1. 拦截所有 `localStorage` 操作（getItem, setItem, removeItem, clear）
2. 将数据同步保存到 uTools 的数据库中
3. 页面加载时自动从 uTools 恢复存档
4. 页面关闭前自动保存最新存档

**优势**：
- ✅ 完全透明，游戏代码无需修改
- ✅ 自动备份到 uTools 数据库
- ✅ 即使清除浏览器缓存，存档也不会丢失
- ✅ 支持多设备同步（如果使用 uTools 云同步）

**文件位置**：
- 桥接器：`src/candybox2/utools-storage-bridge.js`
- 已集成到：`src/candybox2/index.html`

---

## 📝 其他可选方案

### 方案二：导出/导入存档功能

在游戏列表界面添加存档管理功能：

**优点**：
- 用户可以手动备份存档
- 可以在不同设备间传输存档

**缺点**：
- 需要用户手动操作
- 不够自动化

**实现步骤**：
1. 在 GameList 组件添加"导出存档"和"导入存档"按钮
2. 读取 Candy Box 2 的 localStorage 数据
3. 生成 JSON 文件供用户下载
4. 支持上传 JSON 文件恢复存档

### 方案三：IndexedDB 持久化

使用 IndexedDB 替代 localStorage：

**优点**：
- IndexedDB 存储容量更大
- 数据结构更灵活

**缺点**：
- 需要修改游戏代码
- 实现复杂度较高

---

## 🔧 使用指南

### 验证存档功能

1. **测试存档是否正常**：
   ```
   1. 打开 Candy Box 2 游戏
   2. 玩一会儿，收集一些糖果
   3. 关闭游戏窗口
   4. 重新打开游戏
   5. 检查糖果数量是否保留
   ```

2. **查看 uTools 数据库**：
   - 打开 uTools 开发者工具
   - 运行：`utools.db.findAll('candybox2_save_')`
   - 应该能看到保存的存档数据

3. **清除存档**：
   如果需要重新开始游戏，可以运行：
   ```javascript
   utools.db.findAll('candybox2_save_').then(docs => {
     docs.forEach(doc => utools.db.remove(doc._id))
   })
   ```

---

## 🐛 故障排除

### 问题：存档仍然丢失

**可能原因**：
1. uTools 数据库权限未开启
2. 桥接器脚本加载失败

**解决方法**：
1. 检查浏览器控制台是否有错误
2. 确认 `utools-storage-bridge.js` 已正确加载
3. 检查 uTools 版本是否支持数据库 API

### 问题：存档无法恢复

**解决方法**：
1. 打开浏览器开发者工具
2. 在 Console 中运行：
   ```javascript
   // 查看所有存档
   utools.db.findAll('candybox2_save_').then(console.log)
   ```
3. 如果有存档但游戏没加载，尝试刷新页面

---

## 📊 技术细节

### 存档数据结构

每个存档项在 uTools 数据库中的结构：
```javascript
{
  _id: "candybox2_save_candy",
  data: "1000",
  updatedAt: 1234567890
}
```

### 键名映射

Candy Box 2 使用的主要 localStorage 键：
- `candy` - 糖果数量
- `lollipops` - 棒棒糖数量
- `candiesEaten` - 已吃糖果数
- `quest_*.completed` - 任务完成状态
- 等等...

### 兼容性

- ✅ uTools 2.0+
- ✅ 所有现代浏览器
- ✅ Electron 环境

---

## 🎮 下一步优化建议

1. **添加存档管理界面**
   - 在游戏列表添加"存档管理"功能
   - 支持导出/导入存档文件
   - 支持多个存档槽位

2. **自动云同步**
   - 利用 uTools 的云同步功能
   - 实现多设备间存档同步

3. **存档备份提醒**
   - 定期提醒用户导出存档
   - 防止意外数据丢失

---

## 📞 支持

如有问题，请检查：
1. 浏览器控制台日志
2. uTools 开发者文档
3. 项目 GitHub Issues
