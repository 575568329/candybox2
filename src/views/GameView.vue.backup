<script setup>
import { ref, onMounted, onUnmounted, computed, markRaw } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { saveManager } from '../utils/saveManager.js'
import CandyBox2 from '../components/CandyBox2.vue'

const route = useRoute()
const router = useRouter()

const game = ref(null)
const isLoading = ref(true)
const hasError = ref(false)
const showSaveManager = ref(false)
const saveInfo = ref({
  hasSave: false,
  count: 0,
  candy: 0,
  lollipops: 0
})
const saveMessage = ref({
  show: false,
  type: 'success',
  text: ''
})

const lastUpdateTime = ref(null)

// æ¸¸æˆé…ç½®
const games = {
  candybox2: {
    id: 'candybox2',
    name: 'ç³–æœç›’å­2',
    englishName: 'Candy Box 2',
    icon: 'ğŸ¬',
    component: markRaw(CandyBox2)
  }
}

// æ£€æŸ¥æ˜¯å¦åœ¨ uTools ç¯å¢ƒä¸­
const isUToolsEnv = computed(() => {
  return typeof window !== 'undefined' && window.utools
})

// åŠ è½½å­˜æ¡£ä¿¡æ¯ï¼ˆç›´æ¥ä» localStorage è¯»å–ï¼‰
const loadSaveInfo = async () => {
  if (!game.value) return

  // ç›´æ¥ä» localStorage è¯»å–å­˜æ¡£
  try {
    const saveSlotKey = 'saveSlot'
    const saveSlotData = localStorage.getItem(saveSlotKey)

    if (saveSlotData) {
      const saveData = typeof saveSlotData === 'string'
        ? JSON.parse(saveSlotData)
        : saveSlotData

      const slots = []
      for (const [key, value] of Object.entries(saveData)) {
        if (key.startsWith('save') && value && typeof value === 'object') {
          const slotNum = key.replace('save', '')
          slots.push({
            slot: slotNum,
            timestamp: value.saveDate || value.timestamp || Date.now(),
            candies: value.candies || value.candy || 0,
            lollipops: value.lollipops || value.lollipop || 0
          })
        }
      }

      if (slots.length > 0) {
        const latestSlot = slots.sort((a, b) => b.timestamp - a.timestamp)[0]
        saveInfo.value = {
          hasSave: true,
          count: localStorage.length,
          candy: latestSlot.candies,
          lollipops: latestSlot.lollipops,
          slots: slots,
          lastUpdate: latestSlot.timestamp,
          source: 'localStorage'
        }
        console.log('[å­˜æ¡£ç®¡ç†å™¨] âœ“ ä» localStorage è¯»å–å­˜æ¡£æˆåŠŸ')
      } else {
        saveInfo.value = { hasSave: false, count: 0 }
      }
    } else {
      saveInfo.value = { hasSave: false, count: 0 }
    }
  } catch (error) {
    console.error('è·å–å­˜æ¡£ä¿¡æ¯å¤±è´¥:', error)
    saveInfo.value = { hasSave: false, count: 0, error: error.message }
  }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
const showMessage = (type, text) => {
  saveMessage.value = { show: true, type, text }
  setTimeout(() => {
    saveMessage.value.show = false
  }, 3000)
}

// å¯¼å‡ºå­˜æ¡£
const exportSave = async () => {
  if (!game.value) return

  const result = await saveManager.exportSave(game.value.id)
  if (result.success) {
    showMessage('success', result.message)
  } else {
    showMessage('error', result.message)
  }
}

// å¯¼å…¥å­˜æ¡£
const importSave = async (event) => {
  if (!game.value) return

  const file = event.target.files?.[0]
  if (!file) return

  const result = await saveManager.importSave(game.value.id, file)
  if (result.success) {
    showMessage('success', result.message)
    await loadSaveInfo()
  } else {
    showMessage('error', result.message)
  }

  // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
  event.target.value = ''
}

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (date) => {
  const now = new Date()
  const diff = Math.floor((now - date) / 1000)

  if (diff < 60) return `${diff}ç§’å‰`
  if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†é’Ÿå‰`
  if (diff < 86400) return `${Math.floor(diff / 3600)}å°æ—¶å‰`
  return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
}

// æ¸…é™¤å­˜æ¡£
const clearSave = async () => {
  if (!game.value) return

  if (!confirm(`ç¡®å®šè¦æ¸…é™¤ã€Š${game.value.name}ã€‹çš„æ‰€æœ‰å­˜æ¡£å—?æ­¤æ“ä½œä¸å¯æ¢å¤!`)) {
    return
  }

  // ç›´æ¥æ¸…é™¤ localStorage
  try {
    const saveSlotKey = 'saveSlot'
    localStorage.removeItem(saveSlotKey)

    showMessage('success', 'å­˜æ¡£å·²æ¸…é™¤')
    await loadSaveInfo()

    // åˆ·æ–°é¡µé¢ä»¥é‡æ–°åŠ è½½æ¸¸æˆ
    setTimeout(() => {
      window.location.reload()
    }, 1000)
  } catch (error) {
    showMessage('error', `æ¸…é™¤å¤±è´¥: ${error.message}`)
  }
}

// è¿”å›æ¸¸æˆåˆ—è¡¨
const goBack = () => {
  router.push('/')
}

let saveRefreshTimer = null

// åˆ·æ–°å­˜æ¡£ä¿¡æ¯
const refreshSaveInfo = async () => {
  if (!game.value) return
  await loadSaveInfo()
  lastUpdateTime.value = new Date()
  console.log(`[å­˜æ¡£åŒæ­¥] å·²æ›´æ–°å­˜æ¡£ä¿¡æ¯`)
}

// æ‰‹åŠ¨åˆ·æ–°å­˜æ¡£
const manualRefreshSave = async () => {
  showMessage('success', 'æ­£åœ¨åˆ·æ–°å­˜æ¡£...')
  await refreshSaveInfo()
  showMessage('success', 'å­˜æ¡£å·²æ›´æ–° âœ“')
}

onMounted(async () => {
  const gameId = route.params.id

  if (!games[gameId]) {
    hasError.value = true
    isLoading.value = false
    return
  }

  game.value = games[gameId]

  // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ç»„ä»¶å·²åŠ è½½
  setTimeout(async () => {
    isLoading.value = false
    await loadSaveInfo()
  }, 500)

  // æ£€æŸ¥æ˜¯å¦åœ¨ uTools ç¯å¢ƒä¸­
  if (!isUToolsEnv.value) {
    console.warn('å½“å‰ä¸åœ¨ uTools ç¯å¢ƒä¸­,éƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨')
  }

  // å®šæœŸåˆ·æ–°å­˜æ¡£ä¿¡æ¯ï¼ˆæ¯5ç§’ï¼‰
  saveRefreshTimer = setInterval(() => {
    refreshSaveInfo()
  }, 5000)
  console.log('[å­˜æ¡£åŒæ­¥] å·²å¯åŠ¨å­˜æ¡£è‡ªåŠ¨åŒæ­¥ï¼ˆæ¯5ç§’ï¼‰')
})

onUnmounted(() => {
  // æ¸…ç†å®šæ—¶å™¨
  if (saveRefreshTimer) {
    clearInterval(saveRefreshTimer)
    console.log('[å­˜æ¡£åŒæ­¥] å·²åœæ­¢å­˜æ¡£è‡ªåŠ¨åŒæ­¥')
  }
})
</script>

<template>
  <div class="game-view">
    <!-- é¡¶éƒ¨æ  -->
    <div class="game-header">
      <div class="header-left">
        <button class="back-btn" @click="goBack" title="è¿”å›æ¸¸æˆåˆ—è¡¨">
          <span class="back-icon">â†</span>
          <span class="back-text">è¿”å›</span>
        </button>
        <div class="game-title">
          <span class="game-icon">{{ game?.icon }}</span>
          <div class="title-text">
            <h1 class="game-name">{{ game?.name }}</h1>
            <p class="game-english-name">{{ game?.englishName }}</p>
          </div>
        </div>
      </div>
      <div class="header-right">
        <button
          class="icon-btn"
          @click="showSaveManager = !showSaveManager"
          title="å­˜æ¡£ç®¡ç†"
        >
          ğŸ’¾ å­˜æ¡£
        </button>
      </div>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="game-container">
      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="isLoading" class="loading-state">
        <div class="loading-spinner"></div>
        <p class="loading-text">æ­£åœ¨åŠ è½½æ¸¸æˆ...</p>
      </div>

      <!-- é”™è¯¯çŠ¶æ€ -->
      <div v-else-if="hasError" class="error-state">
        <div class="error-icon">âš ï¸</div>
        <h2 class="error-title">æ¸¸æˆåŠ è½½å¤±è´¥</h2>
        <p class="error-message">æ— æ³•åŠ è½½æ¸¸æˆ,è¯·æ£€æŸ¥æ¸¸æˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>
        <button class="error-btn" @click="goBack">è¿”å›æ¸¸æˆåˆ—è¡¨</button>
      </div>

      <!-- æ¸¸æˆç»„ä»¶ -->
      <component
        v-if="!isLoading && !hasError && game"
        :is="game.component"
        class="game-component"
      />
    </div>

    <!-- å­˜æ¡£ç®¡ç†é¢æ¿ -->
    <transition name="slide">
      <div v-if="showSaveManager" class="save-manager-overlay" @click="showSaveManager = false">
        <div class="save-manager-panel" @click.stop>
          <div class="save-manager-header">
            <h3>ğŸ’¾ å­˜æ¡£ç®¡ç†</h3>
            <div class="header-actions">
              <button class="refresh-btn" @click="manualRefreshSave" title="åˆ·æ–°å­˜æ¡£ä¿¡æ¯">
                ğŸ”„
              </button>
              <button class="close-btn" @click="showSaveManager = false">âœ•</button>
            </div>
          </div>

          <div class="save-manager-content">
            <!-- å­˜æ¡£ä¿¡æ¯ -->
            <div class="save-info-section">
              <div class="section-header">
                <h4>å½“å‰å­˜æ¡£</h4>
                <span v-if="lastUpdateTime" class="update-time">
                  æ›´æ–°äº {{ formatTime(lastUpdateTime) }}
                </span>
              </div>
              <div v-if="saveInfo.hasSave" class="save-info">
                <div class="info-item">
                  <span class="info-label">ğŸ¬ ç³–æœ:</span>
                  <span class="info-value highlight">{{ saveInfo.candy?.toLocaleString() || 0 }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ğŸ­ æ£’æ£’ç³–:</span>
                  <span class="info-value highlight">{{ saveInfo.lollipops?.toLocaleString() || 0 }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ğŸ“¦ å­˜æ¡£é¡¹:</span>
                  <span class="info-value">{{ saveInfo.count }} ä¸ª</span>
                </div>
              </div>
              <div v-else class="no-save">
                <span class="no-save-icon">ğŸ“­</span>
                <p>æš‚æ— å­˜æ¡£</p>
              </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="save-actions">
              <button class="action-btn primary" @click="exportSave">
                <span class="btn-icon">ğŸ“¤</span>
                <span>å¯¼å‡ºå­˜æ¡£</span>
              </button>
              <button class="action-btn" @click="$refs.importInput.click()">
                <span class="btn-icon">ğŸ“¥</span>
                <span>å¯¼å…¥å­˜æ¡£</span>
              </button>
              <input
                ref="importInput"
                type="file"
                accept=".json"
                style="display: none"
                @change="importSave"
              />
              <button
                v-if="saveInfo.hasSave"
                class="action-btn danger"
                @click="clearSave"
              >
                <span class="btn-icon">ğŸ—‘ï¸</span>
                <span>æ¸…é™¤å­˜æ¡£</span>
              </button>
            </div>

            <!-- æç¤ºä¿¡æ¯ -->
            <div class="save-tips">
              <p>ğŸ’¡ æç¤º:æ¸…é™¤å­˜æ¡£åä¼šåˆ·æ–°æ¸¸æˆ,è¯·ç¡®ä¿å·²å¯¼å‡ºå¤‡ä»½</p>
            </div>
          </div>

          <!-- æ¶ˆæ¯æç¤º -->
          <transition name="fade">
            <div v-if="saveMessage.show" :class="['save-message', saveMessage.type]">
              {{ saveMessage.text }}
            </div>
          </transition>
        </div>
      </div>
    </transition>
  </div>
</template>

<style scoped>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

.game-view {
  width: 100%;
  height: 100vh;
  background: #1a1a2e;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* é¡¶éƒ¨æ  */
.game-header {
  height: 64px;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  flex-shrink: 0;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.back-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: white;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.back-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateX(-2px);
}

.back-icon {
  font-size: 18px;
  line-height: 1;
}

.back-text {
  font-weight: 500;
}

.game-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.game-icon {
  font-size: 32px;
  line-height: 1;
}

.title-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.game-name {
  font-size: 18px;
  font-weight: 600;
  color: white;
  line-height: 1.2;
}

.game-english-name {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.6);
  line-height: 1.2;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.icon-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: white;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.3);
}

/* æ¸¸æˆå®¹å™¨ */
.game-container {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: #ffffff;
}

.game-component {
  width: 100%;
  height: 100%;
  border: none;
}

/* åŠ è½½çŠ¶æ€ */
.loading-state {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  background: #1a1a2e;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.loading-text {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.8);
}

/* é”™è¯¯çŠ¶æ€ */
.error-state {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  background: #1a1a2e;
  padding: 20px;
}

.error-icon {
  font-size: 64px;
  opacity: 0.5;
}

.error-title {
  font-size: 24px;
  font-weight: 600;
  color: white;
}

.error-message {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.6);
  text-align: center;
  max-width: 400px;
}

.error-btn {
  margin-top: 16px;
  padding: 10px 24px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  color: white;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.error-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.3);
}

/* å­˜æ¡£ç®¡ç†é¢æ¿ */
.save-manager-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.save-manager-panel {
  background: linear-gradient(135deg, #1e1e32 0%, #1a1a2e 100%);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  width: 90%;
  max-width: 480px;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  position: relative;
}

.save-manager-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.save-manager-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: white;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.refresh-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.refresh-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: rotate(180deg);
}

.close-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  color: white;
}

.save-manager-content {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
}

.save-info-section {
  margin-bottom: 24px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.save-info-section h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.9);
}

.update-time {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.5);
  font-weight: 400;
}

.save-info {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 16px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.info-item:last-child {
  border-bottom: none;
}

.info-label {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
}

.info-value {
  font-size: 14px;
  font-weight: 600;
  color: white;
}

.info-value.highlight {
  font-size: 16px;
  color: #ffd93d;
}

.no-save {
  text-align: center;
  padding: 32px 16px;
  color: rgba(255, 255, 255, 0.5);
}

.no-save-icon {
  font-size: 48px;
  display: block;
  margin-bottom: 12px;
  opacity: 0.5;
}

.no-save p {
  margin: 0;
  font-size: 14px;
}

.save-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px 20px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.08);
  color: white;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.action-btn:hover {
  background: rgba(255, 255, 255, 0.12);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.action-btn.primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: transparent;
}

.action-btn.primary:hover {
  background: linear-gradient(135deg, #7b8ff0 0%, #8b5bb8 100%);
}

.action-btn.danger {
  background: rgba(255, 107, 107, 0.15);
  border-color: rgba(255, 107, 107, 0.3);
  color: #ff6b6b;
}

.action-btn.danger:hover {
  background: rgba(255, 107, 107, 0.25);
  border-color: rgba(255, 107, 107, 0.4);
}

.btn-icon {
  font-size: 16px;
}

.save-tips {
  padding: 12px;
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid rgba(255, 193, 7, 0.2);
  border-radius: 8px;
}

.save-tips p {
  margin: 0;
  font-size: 12px;
  color: rgba(255, 193, 7, 0.9);
  line-height: 1.5;
}

.save-message {
  position: absolute;
  bottom: 24px;
  left: 24px;
  right: 24px;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  text-align: center;
}

.save-message.success {
  background: rgba(76, 175, 80, 0.15);
  border: 1px solid rgba(76, 175, 80, 0.3);
  color: #4caf50;
}

.save-message.error {
  background: rgba(244, 67, 54, 0.15);
  border: 1px solid rgba(244, 67, 54, 0.3);
  color: #f44336;
}

/* åŠ¨ç”» */
.slide-enter-active,
.slide-leave-active {
  transition: opacity 0.3s;
}

.slide-enter-from,
.slide-leave-to {
  opacity: 0;
}

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>
